<!DOCTYPE html><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<link rel="alternate" type="application/atom+xml" href="/feed.atom">
<link rel="shortcut icon" href="../graphics/logo3.svg">
<title>SQL Relational Algebra</title>
<meta name="description" content="Relational algebra offers an alternative syntax for crafting relational database queries.  I demonstrate how to use Python and Relational.py to create relational database queries and translate them into SQL.">
<meta name="keywords" content="sql, relational algebra, python">
<meta name="generator" content="Org mode">
<link rel="stylesheet" type="text/css" href="../css/main.css">
<link rel="stylesheet" type="text/css" href="../css/exposition.css">
<link rel="stylesheet" type="text/css" href="../css/blog.css">
</head>
<body>
<header id="masthead"><input id="expand-blog-menu" type="checkbox"><div id="dwhoman-logo" class="nav"><a href="../index.html"><span>D</span><span>W</span><span>H</span></a></div>
<label id="expand-blog-menu-inactive" class="nav menu menu-btn" for="expand-blog-menu"><span>Blog</span><img src="../graphics/noun_1322581_cc.svg" alt=""></label><label id="expand-blog-menu-active" class="nav blog-menu menu-btn" for="expand-blog-menu"><span>Main Menu</span><img src="../graphics/noun_1355740_cc.svg" alt=""></label><div id="blog-chronologic" class="nav blog-menu menu-btn"><a href="../chronological.html"><span>Chronological</span><img src="../graphics/noun_333757_cc.svg" alt=""></a></div>
<div id="blog-recent" class="nav blog-menu menu-btn"><a href="../recent-updates.html"><span>Updated</span><img src="../graphics/noun_1572678_cc.svg" alt=""></a></div>
<div id="blog-categories" class="nav blog-menu menu-btn"><a href="../categories.xhtml"><span>Categories</span><img src="../graphics/noun_1332809_cc.svg" alt=""></a></div>
<div id="blog-threads" class="nav blog-menu menu-btn"><a href="../threads.html"><span>Threads</span><img src="../graphics/noun_844785_cc.svg" alt=""></a></div>
<div id="blog-feed" class="nav blog-menu menu-btn"><a href="../feed.atom"><span>Feed</span><img src="../graphics/noun_19895_cc.svg" alt=""></a></div>
<div id="about-page" class="nav menu menu-btn"><a href="../about.html"><span>About</span><img src="../graphics/info.svg" alt=""></a></div>
<div id="resume-page" class="nav menu menu-btn"><a href="../resume.html"><span>R<span class="acute-e">e</span>sum<span class="acute-e">e</span></span><img src="../graphics/noun_591006_cc.svg" alt=""></a></div>
<div id="project-page" class="nav menu menu-btn"><a href="https://github.com/dwhoman"><span>Projects</span><img src="../graphics/Git-logo.svg" alt=""></a></div>
<div id="following-page" class="menu filler"></div>
<div id="blog-feed-comp" class="filler menu"></div>
<div id="nav-filler" class="filler"></div>
<div id="to-top" class="nav menu-btn"><a href="#"><span>Back to Top</span><img src="../graphics/to_top.svg" alt=""></a></div></header><aside id="related-posts"><nav><h2>Thread</h2>
<dl id="blog-threads">
<dt>Next:</dt>
<dd class="cloud"><a href="sql-recursive-queries.html">SQL Recursive Queries</a></dd>
</dl></nav><nav><h2>Published</h2>
<dl id="blog-published">
<dt>Prev:</dt>
<dd class="cloud"><a href="sql-transitive-closure.html">Transitive Closure in SQL</a></dd>
</dl></nav><nav><h2>Updated</h2>
<dl id="blog-updated">
<dt>Next:</dt>
<dd class="cloud"><a href="hy-shell-scripting.html">Shell Scripting with Hy!</a></dd>
</dl></nav></aside><main id="content">
<h1 class="title">SQL Relational Algebra</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li>
<a href="#org94219d3">1. Relational Algebra and SQL</a>
<ul>
<li><a href="#org7d2a681">1.1. Interacting with Relational</a></li>
<li><a href="#orgceeb1ae">1.2. Chinook Database</a></li>
<li>
<a href="#orgee7e9c4">1.3. Relational Algebra in Python</a>
<ul>
<li><a href="#org45d60cf">1.3.1. Selection</a></li>
<li><a href="#org1782b05">1.3.2. Projection</a></li>
<li><a href="#orgdcea6f6">1.3.3. Rename</a></li>
<li><a href="#orga87273b">1.3.4. Product</a></li>
<li><a href="#org6ea1051">1.3.5. Set Operations</a></li>
<li><a href="#org04cab26">1.3.6. Joins</a></li>
</ul>
</li>
<li>
<a href="#org5dc890c">1.4. Complex Queries</a>
<ul>
<li><a href="#org3596ee1">1.4.1. Multiple Joins</a></li>
<li><a href="#org4e5f40a">1.4.2. Adding Division</a></li>
<li><a href="#org588d383">1.4.3. With Correlated Subqueries</a></li>
<li><a href="#org2ee2315">1.4.4. With the Relation Algebra Definition</a></li>
<li><a href="#orgda58b58">1.4.5. Gotcha with Except</a></li>
</ul>
</li>
<li><a href="#org5ea39c9">1.5. Conclusion</a></li>
</ul>
</li>
</ul>
</div>
</div>

<article id="outline-container-org94219d3" class="outline-2">
<h2 id="org94219d3">
<span class="section-number-2">1</span> Relational Algebra and SQL</h2>
<div class="outline-text-2" id="text-1">
<p>
The dominant language for writing relational database queries is SQL.
Unfortunately, SQL tends to get very complicated very quickly as the query's
complexity increases. Furthermore, SQL is far removed, syntactically, from much
of the theoretical basis of querying, <a href="https://en.wikipedia.org/wiki/Relational_algebra">relation algebra</a>. For creating complicated
queries, I prototype them in Python using modules from the relational algebra
program, <a href="https://ltworf.github.io/relational/">Relational</a>. I forked the code on <a href="https://github.com/dwhoman/relational">GitHub</a> and added additional operators
as well as code to interface with <a href="https://www.gnu.org/software/emacs/">Emacs</a> <a href="http://orgmode.org/">Org Mode</a> <a href="http://orgmode.org/worg/org-contrib/babel/">Babel</a>. You can download an
<a href="https://drive.google.com/open?id=0B-O-rtcjwX6gWHQ5dlJhdFplenM">Org file</a> containing the code examples that are described in this post.  Also
required to run the examples is the <a href="https://chinookdatabase.codeplex.com/">Chinook</a> database and a <a href="https://drive.google.com/file/d/0B-O-rtcjwX6gVUFVQ0ZSNlJwbzg/view?usp=sharing">CSV version</a> of the
database.
</p>
</div>
<div id="outline-container-org7d2a681" class="outline-3">
<h3 id="org7d2a681">
<span class="section-number-3">1.1</span> Interacting with Relational</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-python" id="orgb925d4e"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
</pre>
</div>

<p>
Relational provides a graphical interface, but I find it easier to interact
with the code using Python. Relational's Relation class represents
relational tables and their operators. Relation requires a file path argument
to initialize. This must be CSV a file, where the first line is the
header and all elements are quoted. In the above code, the path to the
Relational code is added to sys.path and Relation objects are created for
each CSV file. The CSV data entries are parsed into four possible
types; string, integer, float, and date, which are defined in
rtypes.py. Relational does not have a null type. Relational's
outer join operators return "—" strings for null values, so three dashes
are also used to represent null in the CSV files. Relational treats
null values as equal, but SQL sometimes treats them as equal and sometimes
not, so some of the examples may need to be changed to treat null equality as
desired. <a href="https://en.wikipedia.org/wiki/Null_(SQL)">Wikipedia</a> has an extensive article on the subject.
</p>

<p>
With the module, relation_org.py, it is also possible to use Emacs Org tables
as input. It provides the class RelationOrg that is derived from the
Relation class. In Org, an input table must be given a name and the
name must be given as a :var argument in the Babel code block. The
column names must be given in the first row and the table must not have any
horizontal separators. The :var variables become global variables in
the Babel code block with list of list values.
</p>

<div class="org-src-container">
<pre class="src src-org"><span class="org-org-meta-line">#+NAME:alpha_table</span>
<span class="org-org-table">| key | value |</span>
<span class="org-org-table">| 1   | A     |</span>

<span class="org-org-block-begin-line">#+BEGIN_SRC python :var alpha_table</span>
<span class="org-org-block"><span class="org-keyword">from</span></span><span class="org-org-block"> relational.relation_org </span><span class="org-org-block"><span class="org-keyword">import</span></span><span class="org-org-block"> RelationOrg</span>
<span class="org-org-block"><span class="org-variable-name">alpha</span></span><span class="org-org-block"> = RelationOrg(alpha_table)</span>
<span class="org-org-block-end-line">#+END_SRC</span>
</pre>
</div>

<p>
In the example, the alpha_table is given the value:
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">alpha_table</span> = [[<span class="org-string">"key"</span>, <span class="org-string">"value"</span>],[<span class="org-string">"1"</span>,<span class="org-string">"A"</span>]]
</pre>
</div>

<p>
RelationOrg's initializer can take either a list of lists or a Relation
object. It is used to convert Org tables to Relation objects and to print out
Relation objects as Org tables, requiring the Python module <a href="https://pypi.python.org/pypi/tabulate">tabulate</a>.
</p>
</div>
</div>

<div id="outline-container-orgceeb1ae" class="outline-3">
<h3 id="orgceeb1ae">
<span class="section-number-3">1.2</span> Chinook Database</h3>
<div class="outline-text-3" id="text-1-2">
<p>
For this post, I will be using the Chinook Database for performing
queries. It is an open source database available for many different
database servers, but does not include CSV files. The example Org file will
need to be modified to correctly reference the Chinook Database, the CSV
files, and the Relational source code.
</p>

<p>
The Chinook database has the following entity-relationship model.
<img src="sql-relational-algebra/ER-diagram.png" alt="ER-diagram.png">
</p>
</div>
</div>

<div id="outline-container-orgee7e9c4" class="outline-3">
<h3 id="orgee7e9c4">
<span class="section-number-3">1.3</span> Relational Algebra in Python</h3>
<div class="outline-text-3" id="text-1-3">
<p>
All relational algebra operations are Relation class methods. Each of
these methods returns a new Relation object. Additionally, the Relation
object has <em>__eq__</em>, <em>__str__</em>, <em>__len__</em>, <em>__iter__</em>, and <em>__contains__</em> methods
defined; and furthermore, the RelationOrg class overrides the <em>__str__</em> method
to return an Org table string.
</p>

<p>
Relational is not a full fledged database system and it tends to be very slow
compared to any SQL engine. Internally, the table data is stored as a
set of tuple rows, and the header is its own Header object type. The
data is accessible through the Relation <em>content</em> variable and header
through the <em>header</em> variable.
</p>
</div>


<div id="outline-container-org45d60cf" class="outline-4">
<h4 id="org45d60cf">
<span class="section-number-4">1.3.1</span> Selection</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
In relational algebra, the selection function selects rows. The selection
method takes a single string of Python code that returns true or
false, which it passes to the <a href="https://docs.python.org/3.5/library/functions.html#compile">compile</a> Python internal and then to eval. The
table's column names get turned into global variables to the code being
evaluated. Numeric strings get turned into numbers, integers or floats, and
dates get turned into <a href="https://docs.python.org/3.5/library/datetime.html">datetime</a> objects. Nulls are represented by "—"
strings. The selection method returns a new table containing only rows
having the specified property. In this example, only rows whose ArtistId
column is 1 are returned.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">sel</span> = album.selection(<span class="org-string">"ArtistId == 1"</span>)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(sel))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">sel</span> = employee.selection(<span class="org-string">"ReportsTo == '---'"</span>)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(sel))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1782b05" class="outline-4">
<h4 id="org1782b05">
<span class="section-number-4">1.3.2</span> Projection</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
Projection performs the same function as SQL selection.&amp;nbsp; It takes one
or more string arguments, the names of which columns to include in the
return table.&amp;nbsp; It can also, instead, take a list of names to project.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">proj</span> = genre.projection(<span class="org-string">"Name"</span>)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(proj))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdcea6f6" class="outline-4">
<h4 id="orgdcea6f6">
<span class="section-number-4">1.3.3</span> Rename</h4>
<div class="outline-text-4" id="text-1-3-3">
<p>
Rename takes a dictionary argument where the keys are the current column
names to replace and the values are the corresponding replacements, with all
keys and values being strings. A new table is returned with renamed
columns. You will have to use this quite often, since the joining methods
require that its input tables have all different column names, save the ones
being joined on.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">rn</span> = employee.rename({<span class="org-string">"LastName"</span>: <span class="org-string">"Family"</span>, <span class="org-string">"FirstName"</span>: <span class="org-string">"Given"</span>})
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(rn))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga87273b" class="outline-4">
<h4 id="orga87273b">
<span class="section-number-4">1.3.4</span> Product</h4>
<div class="outline-text-4" id="text-1-3-4">
<p>
Performs a Cartesian product between two tables and returns a new
table. The method takes a table as its argument, and applies its
argument and it's object to the product operation. None of the columns
names in one table can be equal to any column names in the other, so
renaming may be necessary.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">prod</span> = employee.product(media_type)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(prod))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> * <span class="org-keyword">FROM</span> Employee, MediaType;
</pre>
</div>
</div>
</div>

<div id="outline-container-org6ea1051" class="outline-4">
<h4 id="org6ea1051">
<span class="section-number-4">1.3.5</span> Set Operations</h4>
<div class="outline-text-4" id="text-1-3-5">
<p>
Relation provides three set operations; union, intersection, and difference.
I added the symmetric difference operation.&amp;nbsp; While symmetric difference
is not strictly part of relational algebra, it is defined in terms of the
other relational algebra set operators.  Each of the set methods require
that both input tables have the same column names.
</p>
</div>

<ol class="org-ol">
<li>
<a id="org71d83a5"></a>Union<br>
<div class="outline-text-5" id="text-1-3-5-1">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">e_state</span> = employee.projection(<span class="org-string">"State"</span>)
<span class="org-variable-name">c_state</span> = customer.projection(<span class="org-string">"State"</span>)
<span class="org-variable-name">union</span> = e_state.union(c_state)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(union))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Customer
<span class="org-keyword">UNION</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Employee;
</pre>
</div>
</div>
</li>

<li>
<a id="org8b2df60"></a>Intersection<br>
<div class="outline-text-5" id="text-1-3-5-2">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">e_state</span> = employee.projection(<span class="org-string">"State"</span>)
<span class="org-variable-name">c_state</span> = customer.projection(<span class="org-string">"State"</span>)
<span class="org-variable-name">inter</span> = c_state.intersection(e_state)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(inter))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Customer
<span class="org-keyword">INTERSECT</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Employee;
</pre>
</div>
</div>
</li>

<li>
<a id="org5808359"></a>Difference<br>
<div class="outline-text-5" id="text-1-3-5-3">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">e_state</span> = employee.projection(<span class="org-string">"State"</span>)
<span class="org-variable-name">c_state</span> = customer.projection(<span class="org-string">"State"</span>)
<span class="org-variable-name">diff</span> = c_state.difference(e_state)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(diff))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Customer
<span class="org-keyword">EXCEPT</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Employee;
</pre>
</div>

<p>
The SQL equivalent to difference is the EXCEPT operator. Not all SQL
engines have the EXCEPT operator, such as MySQL.  <a href="https://en.wikipedia.org/wiki/Set_operations_(SQL)#EXCEPT_operator">Wikipedia</a> has an example
of how to create an except, using left outer join.
</p>
</div>
</li>

<li>
<a id="orge4080ec"></a>Symmetric Difference, XOR<br>
<div class="outline-text-5" id="text-1-3-5-4">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">e_state</span> = employee.projection(<span class="org-string">"State"</span>)
<span class="org-variable-name">c_state</span> = customer.projection(<span class="org-string">"State"</span>)
<span class="org-variable-name">sym</span> = e_state.symmetric_diff(c_state)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(sym))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> * <span class="org-keyword">FROM</span>
(<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Customer
<span class="org-keyword">UNION</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Employee)
<span class="org-keyword">EXCEPT</span>
<span class="org-keyword">SELECT</span> * <span class="org-keyword">FROM</span>
(<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Customer
<span class="org-keyword">INTERSECT</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Employee);
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org04cab26" class="outline-4">
<h4 id="org04cab26">
<span class="section-number-4">1.3.6</span> Joins</h4>
<div class="outline-text-4" id="text-1-3-6">
<p>
The Relational program comes with most of the relational algebra join
operations including the extended relational algebra outer join
operations.&amp;nbsp; I added semijoin_left, semijoin_right, and antijoin.&amp;nbsp;
Also note that null values are considered equal.
</p>
</div>

<ol class="org-ol">
<li>
<a id="org2e4fbe4"></a>Natural Join and Semijoin<br>
<div class="outline-text-5" id="text-1-3-6-1">
<p>
The natural join methods (join, semijoin_left, and semijoin_right) each
take one argument, join its table object to the argument table. and return
a new table.&amp;nbsp; The join method returns a table with all the different
column names in each table.&amp;nbsp; semijoin_left returns only those columns
in the method's object, while semijoin_right returns only those columns in
the table argument.&amp;nbsp; Tables will be joined on columns with equivalent
names.&amp;nbsp; If there are no names in common, then the Cartesian product is
returned.
</p>
</div>
<ol class="org-ol">
<li>
<a id="orgbfc2096"></a>Natural Join<br>
<div class="outline-text-6" id="text-1-3-6-1-1">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">cn</span> = customer.rename({<span class="org-string">"SupportRepId"</span>: <span class="org-string">"EmployeeId"</span>, <span class="org-string">"LastName"</span>: <span class="org-string">"cLastName"</span>,
                      <span class="org-string">"FirstName"</span>: <span class="org-string">"cFirstName"</span>, <span class="org-string">"Company"</span>: <span class="org-string">"cCompany"</span>,
                      <span class="org-string">"Address"</span>: <span class="org-string">"cAddress"</span>, <span class="org-string">"City"</span>: <span class="org-string">"cCity"</span>, <span class="org-string">"State"</span>: <span class="org-string">"cState"</span>,
                      <span class="org-string">"Country"</span>: <span class="org-string">"cCountry"</span>, <span class="org-string">"PostalCode"</span>: <span class="org-string">"cPostalCode"</span>,
                      <span class="org-string">"Phone"</span>: <span class="org-string">"cPhone"</span>, <span class="org-string">"Fax"</span>: <span class="org-string">"cFax"</span>, <span class="org-string">"Email"</span>: <span class="org-string">"cEmail"</span>})
<span class="org-variable-name">jn</span> = employee.join(cn)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(jn))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> EmployeeId,
                Employee.LastName <span class="org-keyword">AS</span> eLastName,
                Employee.FirstName <span class="org-keyword">AS</span> eFirstName,
                Employee.Title <span class="org-keyword">AS</span> eTitle,
                Employee.ReportsTo <span class="org-keyword">AS</span> eReportsTo,
                Employee.BirthDate <span class="org-keyword">AS</span> eBirthDate,
                Employee.HireDate <span class="org-keyword">AS</span> eHireDate,
                Employee.Address <span class="org-keyword">AS</span> eAddress,
                Employee.City <span class="org-keyword">AS</span> eCity,
                Employee.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> eState,
                Employee.Country <span class="org-keyword">AS</span> eCountry,
                Employee.PostalCode <span class="org-keyword">AS</span> ePostalCode,
                Employee.Phone <span class="org-keyword">AS</span> ePhone,
                Employee.Fax <span class="org-keyword">AS</span> eFax,
                Employee.Email <span class="org-keyword">AS</span> eEmail,
                Customer.CustomerId <span class="org-keyword">AS</span> cCustomerId,
                Customer.FirstName <span class="org-keyword">AS</span> cFirstName,
                Customer.LastName <span class="org-keyword">AS</span> cLastName,
                Customer.Company <span class="org-keyword">AS</span> cCompany,
                Customer.Address <span class="org-keyword">AS</span> cAddress,
                Customer.City <span class="org-keyword">AS</span> cCity,
                Customer.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> cState,
                Customer.Country <span class="org-keyword">AS</span> cCountry,
                Customer.PostalCode <span class="org-keyword">AS</span> cPostalCode,
                Customer.Phone <span class="org-keyword">AS</span> cPhone,
                Customer.Fax <span class="org-keyword">AS</span> cFax,
                Customer.Email <span class="org-keyword">AS</span> cEmail
<span class="org-keyword">FROM</span> Employee <span class="org-keyword">JOIN</span> Customer
<span class="org-keyword">ON</span> Employee.EmployeeId = Customer.SupportRepId;
</pre>
</div>
</div>
</li>
<li>
<a id="orgbf79881"></a>Semijoin Left<br>
<div class="outline-text-6" id="text-1-3-6-1-2">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">cn</span> = customer.rename({<span class="org-string">"SupportRepId"</span>: <span class="org-string">"EmployeeId"</span>, <span class="org-string">"LastName"</span>: <span class="org-string">"cLastName"</span>,
                      <span class="org-string">"FirstName"</span>: <span class="org-string">"cFirstName"</span>, <span class="org-string">"Company"</span>: <span class="org-string">"cCompany"</span>,
                      <span class="org-string">"Address"</span>: <span class="org-string">"cAddress"</span>, <span class="org-string">"City"</span>: <span class="org-string">"cCity"</span>, <span class="org-string">"State"</span>: <span class="org-string">"cState"</span>,
                      <span class="org-string">"Country"</span>: <span class="org-string">"cCountry"</span>, <span class="org-string">"PostalCode"</span>: <span class="org-string">"cPostalCode"</span>,
                      <span class="org-string">"Phone"</span>: <span class="org-string">"cPhone"</span>, <span class="org-string">"Fax"</span>: <span class="org-string">"cFax"</span>, <span class="org-string">"Email"</span>: <span class="org-string">"cEmail"</span>})
<span class="org-variable-name">jn</span> = employee.semijoin_left(cn)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(jn))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> EmployeeId,
                Employee.LastName <span class="org-keyword">AS</span> eLastName,
                Employee.FirstName <span class="org-keyword">AS</span> eFirstName,
                Employee.Title <span class="org-keyword">AS</span> eTitle,
                Employee.ReportsTo <span class="org-keyword">AS</span> eReportsTo,
                Employee.BirthDate <span class="org-keyword">AS</span> eBirthDate,
                Employee.HireDate <span class="org-keyword">AS</span> eHireDate,
                Employee.Address <span class="org-keyword">AS</span> eAddress,
                Employee.City <span class="org-keyword">AS</span> eCity,
                Employee.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> eState,
                Employee.Country <span class="org-keyword">AS</span> eCountry,
                Employee.PostalCode <span class="org-keyword">AS</span> ePostalCode,
                Employee.Phone <span class="org-keyword">AS</span> ePhone,
                Employee.Fax <span class="org-keyword">AS</span> eFax,
                Employee.Email <span class="org-keyword">AS</span> eEmail
<span class="org-keyword">FROM</span> Employee <span class="org-keyword">JOIN</span> Customer
<span class="org-keyword">ON</span> Employee.EmployeeId = Customer.SupportRepId;
</pre>
</div>
</div>
</li>

<li>
<a id="orgc862976"></a>Semijoin Right<br>
<div class="outline-text-6" id="text-1-3-6-1-3">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">cn</span> = customer.rename({<span class="org-string">"SupportRepId"</span>: <span class="org-string">"EmployeeId"</span>, <span class="org-string">"LastName"</span>: <span class="org-string">"cLastName"</span>,
                      <span class="org-string">"FirstName"</span>: <span class="org-string">"cFirstName"</span>, <span class="org-string">"Company"</span>: <span class="org-string">"cCompany"</span>,
                      <span class="org-string">"Address"</span>: <span class="org-string">"cAddress"</span>, <span class="org-string">"City"</span>: <span class="org-string">"cCity"</span>, <span class="org-string">"State"</span>: <span class="org-string">"cState"</span>,
                      <span class="org-string">"Country"</span>: <span class="org-string">"cCountry"</span>, <span class="org-string">"PostalCode"</span>: <span class="org-string">"cPostalCode"</span>,
                      <span class="org-string">"Phone"</span>: <span class="org-string">"cPhone"</span>, <span class="org-string">"Fax"</span>: <span class="org-string">"cFax"</span>, <span class="org-string">"Email"</span>: <span class="org-string">"cEmail"</span>})
<span class="org-variable-name">jn</span> = employee.semijoin_right(cn)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(jn))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> EmployeeId,
                Customer.CustomerId <span class="org-keyword">AS</span> cCustomerId,
                Customer.FirstName <span class="org-keyword">AS</span> cFirstName,
                Customer.LastName <span class="org-keyword">AS</span> cLastName,
                Customer.Company <span class="org-keyword">AS</span> cCompany,
                Customer.Address <span class="org-keyword">AS</span> cAddress,
                Customer.City <span class="org-keyword">AS</span> cCity,
                Customer.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> cState,
                Customer.Country <span class="org-keyword">AS</span> cCountry,
                Customer.PostalCode <span class="org-keyword">AS</span> cPostalCode,
                Customer.Phone <span class="org-keyword">AS</span> cPhone,
                Customer.Fax <span class="org-keyword">AS</span> cFax,
                Customer.Email <span class="org-keyword">AS</span> cEmail
<span class="org-keyword">FROM</span> Employee <span class="org-keyword">JOIN</span> Customer
<span class="org-keyword">ON</span> Employee.EmployeeId = Customer.SupportRepId;
</pre>
</div>
</div>
</li>
</ol>
</li>

<li>
<a id="org0317b96"></a>Theta Join<br>
<div class="outline-text-5" id="text-1-3-6-2">
<p>
The thetajoin method requires two arguments; the table to join on and a
selection argument.&amp;nbsp; Internally, it performs the Cartesian product on
the two tables and selects those rows from the resulting table satisfying
the input expression.&amp;nbsp; So all column names must be unique.&amp;nbsp; Refer
to the section on Selection for details on the selection argument.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">cn</span> = customer.rename({<span class="org-string">"LastName"</span>: <span class="org-string">"cLastName"</span>,
                      <span class="org-string">"FirstName"</span>: <span class="org-string">"cFirstName"</span>, <span class="org-string">"Company"</span>: <span class="org-string">"cCompany"</span>,
                      <span class="org-string">"Address"</span>: <span class="org-string">"cAddress"</span>, <span class="org-string">"City"</span>: <span class="org-string">"cCity"</span>, <span class="org-string">"State"</span>: <span class="org-string">"cState"</span>,
                      <span class="org-string">"Country"</span>: <span class="org-string">"cCountry"</span>, <span class="org-string">"PostalCode"</span>: <span class="org-string">"cPostalCode"</span>,
                      <span class="org-string">"Phone"</span>: <span class="org-string">"cPhone"</span>, <span class="org-string">"Fax"</span>: <span class="org-string">"cFax"</span>, <span class="org-string">"Email"</span>: <span class="org-string">"cEmail"</span>})
<span class="org-variable-name">jn</span> = employee.thetajoin(cn, <span class="org-string">"SupportRepId == 1 + EmployeeId"</span>)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(jn))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> EmployeeId,
                SupportRepId,
                Employee.LastName <span class="org-keyword">AS</span> eLastName,
                Employee.FirstName <span class="org-keyword">AS</span> eFirstName,
                Employee.Title <span class="org-keyword">AS</span> eTitle,
                Employee.ReportsTo <span class="org-keyword">AS</span> eReportsTo,
                Employee.BirthDate <span class="org-keyword">AS</span> eBirthDate,
                Employee.HireDate <span class="org-keyword">AS</span> eHireDate,
                Employee.Address <span class="org-keyword">AS</span> eAddress,
                Employee.City <span class="org-keyword">AS</span> eCity,
                Employee.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> eState,
                Employee.Country <span class="org-keyword">AS</span> eCountry,
                Employee.PostalCode <span class="org-keyword">AS</span> ePostalCode,
                Employee.Phone <span class="org-keyword">AS</span> ePhone,
                Employee.Fax <span class="org-keyword">AS</span> eFax,
                Employee.Email <span class="org-keyword">AS</span> eEmail,
                Customer.CustomerId <span class="org-keyword">AS</span> cCustomerId,
                Customer.FirstName <span class="org-keyword">AS</span> cFirstName,
                Customer.LastName <span class="org-keyword">AS</span> cLastName,
                Customer.Company <span class="org-keyword">AS</span> cCompany,
                Customer.Address <span class="org-keyword">AS</span> cAddress,
                Customer.City <span class="org-keyword">AS</span> cCity,
                Customer.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> cState,
                Customer.Country <span class="org-keyword">AS</span> cCountry,
                Customer.PostalCode <span class="org-keyword">AS</span> cPostalCode,
                Customer.Phone <span class="org-keyword">AS</span> cPhone,
                Customer.Fax <span class="org-keyword">AS</span> cFax,
                Customer.Email <span class="org-keyword">AS</span> cEmail
<span class="org-keyword">FROM</span> Employee <span class="org-keyword">JOIN</span> Customer
<span class="org-keyword">ON</span> Employee.EmployeeId = 1 + Customer.SupportRepId;
</pre>
</div>
</div>
</li>


<li>
<a id="org1a45cd3"></a>Outer Joins<br>
<div class="outline-text-5" id="text-1-3-6-3">
<p>
Relation provides full outer join (outer), outer join left (outer_left),
and&amp;nbsp; outer join right (outer_right).&amp;nbsp; When printing the result of
an outer join, null is represented by "—".&amp;nbsp; Like the natural join
methods, these methods take a single table argument and perform a join with
the method's object.
</p>
</div>
<ol class="org-ol">
<li>
<a id="org80199b8"></a>Outer Left Join<br>
<div class="outline-text-6" id="text-1-3-6-3-1">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">cn</span> = customer.rename({<span class="org-string">"SupportRepId"</span>: <span class="org-string">"EmployeeId"</span>, <span class="org-string">"LastName"</span>: <span class="org-string">"cLastName"</span>,
                      <span class="org-string">"FirstName"</span>: <span class="org-string">"cFirstName"</span>, <span class="org-string">"Company"</span>: <span class="org-string">"cCompany"</span>,
                      <span class="org-string">"Address"</span>: <span class="org-string">"cAddress"</span>, <span class="org-string">"City"</span>: <span class="org-string">"cCity"</span>, <span class="org-string">"State"</span>: <span class="org-string">"cState"</span>,
                      <span class="org-string">"Country"</span>: <span class="org-string">"cCountry"</span>, <span class="org-string">"PostalCode"</span>: <span class="org-string">"cPostalCode"</span>,
                      <span class="org-string">"Phone"</span>: <span class="org-string">"cPhone"</span>, <span class="org-string">"Fax"</span>: <span class="org-string">"cFax"</span>, <span class="org-string">"Email"</span>: <span class="org-string">"cEmail"</span>})
<span class="org-variable-name">jn</span> = employee.outer_left(cn)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(jn))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> EmployeeId,
                Employee.LastName <span class="org-keyword">AS</span> eLastName,
                Employee.FirstName <span class="org-keyword">AS</span> eFirstName,
                Employee.Title <span class="org-keyword">AS</span> eTitle,
                Employee.ReportsTo <span class="org-keyword">AS</span> eReportsTo,
                Employee.BirthDate <span class="org-keyword">AS</span> eBirthDate,
                Employee.HireDate <span class="org-keyword">AS</span> eHireDate,
                Employee.Address <span class="org-keyword">AS</span> eAddress,
                Employee.City <span class="org-keyword">AS</span> eCity,
                Employee.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> eState,
                Employee.Country <span class="org-keyword">AS</span> eCountry,
                Employee.PostalCode <span class="org-keyword">AS</span> ePostalCode,
                Employee.Phone <span class="org-keyword">AS</span> ePhone,
                Employee.Fax <span class="org-keyword">AS</span> eFax,
                Employee.Email <span class="org-keyword">AS</span> eEmail,
                Customer.CustomerId <span class="org-keyword">AS</span> cCustomerId,
                Customer.FirstName <span class="org-keyword">AS</span> cFirstName,
                Customer.LastName <span class="org-keyword">AS</span> cLastName,
                Customer.Company <span class="org-keyword">AS</span> cCompany,
                Customer.Address <span class="org-keyword">AS</span> cAddress,
                Customer.City <span class="org-keyword">AS</span> cCity,
                Customer.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> cState,
                Customer.Country <span class="org-keyword">AS</span> cCountry,
                Customer.PostalCode <span class="org-keyword">AS</span> cPostalCode,
                Customer.Phone <span class="org-keyword">AS</span> cPhone,
                Customer.Fax <span class="org-keyword">AS</span> cFax,
                Customer.Email <span class="org-keyword">AS</span> cEmail
<span class="org-keyword">FROM</span> Employee <span class="org-keyword">LEFT</span> <span class="org-keyword">JOIN</span> Customer
<span class="org-keyword">ON</span> Employee.EmployeeId = Customer.SupportRepId;
</pre>
</div>
</div>
</li>
<li>
<a id="orga7748d0"></a>Outer Right Join<br>
<div class="outline-text-6" id="text-1-3-6-3-2">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">cn</span> = customer.rename({<span class="org-string">"SupportRepId"</span>: <span class="org-string">"EmployeeId"</span>, <span class="org-string">"LastName"</span>: <span class="org-string">"cLastName"</span>,
                      <span class="org-string">"FirstName"</span>: <span class="org-string">"cFirstName"</span>, <span class="org-string">"Company"</span>: <span class="org-string">"cCompany"</span>,
                      <span class="org-string">"Address"</span>: <span class="org-string">"cAddress"</span>, <span class="org-string">"City"</span>: <span class="org-string">"cCity"</span>, <span class="org-string">"State"</span>: <span class="org-string">"cState"</span>,
                      <span class="org-string">"Country"</span>: <span class="org-string">"cCountry"</span>, <span class="org-string">"PostalCode"</span>: <span class="org-string">"cPostalCode"</span>,
                      <span class="org-string">"Phone"</span>: <span class="org-string">"cPhone"</span>, <span class="org-string">"Fax"</span>: <span class="org-string">"cFax"</span>, <span class="org-string">"Email"</span>: <span class="org-string">"cEmail"</span>})
<span class="org-variable-name">jn</span> = employee.outer_right(cn)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(jn))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> EmployeeId,
                Employee.LastName <span class="org-keyword">AS</span> eLastName,
                Employee.FirstName <span class="org-keyword">AS</span> eFirstName,
                Employee.Title <span class="org-keyword">AS</span> eTitle,
                Employee.ReportsTo <span class="org-keyword">AS</span> eReportsTo,
                Employee.BirthDate <span class="org-keyword">AS</span> eBirthDate,
                Employee.HireDate <span class="org-keyword">AS</span> eHireDate,
                Employee.Address <span class="org-keyword">AS</span> eAddress,
                Employee.City <span class="org-keyword">AS</span> eCity,
                Employee.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> eState,
                Employee.Country <span class="org-keyword">AS</span> eCountry,
                Employee.PostalCode <span class="org-keyword">AS</span> ePostalCode,
                Employee.Phone <span class="org-keyword">AS</span> ePhone,
                Employee.Fax <span class="org-keyword">AS</span> eFax,
                Employee.Email <span class="org-keyword">AS</span> eEmail,
                Customer.CustomerId <span class="org-keyword">AS</span> cCustomerId,
                Customer.FirstName <span class="org-keyword">AS</span> cFirstName,
                Customer.LastName <span class="org-keyword">AS</span> cLastName,
                Customer.Company <span class="org-keyword">AS</span> cCompany,
                Customer.Address <span class="org-keyword">AS</span> cAddress,
                Customer.City <span class="org-keyword">AS</span> cCity,
                Customer.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> cState,
                Customer.Country <span class="org-keyword">AS</span> cCountry,
                Customer.PostalCode <span class="org-keyword">AS</span> cPostalCode,
                Customer.Phone <span class="org-keyword">AS</span> cPhone,
                Customer.Fax <span class="org-keyword">AS</span> cFax,
                Customer.Email <span class="org-keyword">AS</span> cEmail
<span class="org-keyword">FROM</span> Customer <span class="org-keyword">LEFT</span> <span class="org-keyword">JOIN</span> Employee
<span class="org-keyword">ON</span> Employee.EmployeeId = Customer.SupportRepId;
</pre>
</div>
</div>
</li>
<li>
<a id="orgc6546e2"></a>Full Outer Join<br>
<div class="outline-text-6" id="text-1-3-6-3-3">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">cn</span> = customer.rename({<span class="org-string">"SupportRepId"</span>: <span class="org-string">"EmployeeId"</span>, <span class="org-string">"LastName"</span>: <span class="org-string">"cLastName"</span>,
                      <span class="org-string">"FirstName"</span>: <span class="org-string">"cFirstName"</span>, <span class="org-string">"Company"</span>: <span class="org-string">"cCompany"</span>,
                      <span class="org-string">"Address"</span>: <span class="org-string">"cAddress"</span>, <span class="org-string">"City"</span>: <span class="org-string">"cCity"</span>, <span class="org-string">"State"</span>: <span class="org-string">"cState"</span>,
                      <span class="org-string">"Country"</span>: <span class="org-string">"cCountry"</span>, <span class="org-string">"PostalCode"</span>: <span class="org-string">"cPostalCode"</span>,
                      <span class="org-string">"Phone"</span>: <span class="org-string">"cPhone"</span>, <span class="org-string">"Fax"</span>: <span class="org-string">"cFax"</span>, <span class="org-string">"Email"</span>: <span class="org-string">"cEmail"</span>})
<span class="org-variable-name">jn</span> = employee.outer(cn)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(jn))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> EmployeeId,
                Employee.LastName <span class="org-keyword">AS</span> eLastName,
                Employee.FirstName <span class="org-keyword">AS</span> eFirstName,
                Employee.Title <span class="org-keyword">AS</span> eTitle,
                Employee.ReportsTo <span class="org-keyword">AS</span> eReportsTo,
                Employee.BirthDate <span class="org-keyword">AS</span> eBirthDate,
                Employee.HireDate <span class="org-keyword">AS</span> eHireDate,
                Employee.Address <span class="org-keyword">AS</span> eAddress,
                Employee.City <span class="org-keyword">AS</span> eCity,
                Employee.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> eState,
                Employee.Country <span class="org-keyword">AS</span> eCountry,
                Employee.PostalCode <span class="org-keyword">AS</span> ePostalCode,
                Employee.Phone <span class="org-keyword">AS</span> ePhone,
                Employee.Fax <span class="org-keyword">AS</span> eFax,
                Employee.Email <span class="org-keyword">AS</span> eEmail,
                Customer.CustomerId <span class="org-keyword">AS</span> cCustomerId,
                Customer.FirstName <span class="org-keyword">AS</span> cFirstName,
                Customer.LastName <span class="org-keyword">AS</span> cLastName,
                Customer.Company <span class="org-keyword">AS</span> cCompany,
                Customer.Address <span class="org-keyword">AS</span> cAddress,
                Customer.City <span class="org-keyword">AS</span> cCity,
                Customer.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> cState,
                Customer.Country <span class="org-keyword">AS</span> cCountry,
                Customer.PostalCode <span class="org-keyword">AS</span> cPostalCode,
                Customer.Phone <span class="org-keyword">AS</span> cPhone,
                Customer.Fax <span class="org-keyword">AS</span> cFax,
                Customer.Email <span class="org-keyword">AS</span> cEmail
<span class="org-keyword">FROM</span> Employee <span class="org-keyword">LEFT</span> <span class="org-keyword">JOIN</span> Customer
<span class="org-keyword">ON</span> Employee.EmployeeId = Customer.SupportRepId
<span class="org-keyword">UNION</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> EmployeeId,
                Employee.LastName <span class="org-keyword">AS</span> eLastName,
                Employee.FirstName <span class="org-keyword">AS</span> eFirstName,
                Employee.Title <span class="org-keyword">AS</span> eTitle,
                Employee.ReportsTo <span class="org-keyword">AS</span> eReportsTo,
                Employee.BirthDate <span class="org-keyword">AS</span> eBirthDate,
                Employee.HireDate <span class="org-keyword">AS</span> eHireDate,
                Employee.Address <span class="org-keyword">AS</span> eAddress,
                Employee.City <span class="org-keyword">AS</span> eCity,
                Employee.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> eState,
                Employee.Country <span class="org-keyword">AS</span> eCountry,
                Employee.PostalCode <span class="org-keyword">AS</span> ePostalCode,
                Employee.Phone <span class="org-keyword">AS</span> ePhone,
                Employee.Fax <span class="org-keyword">AS</span> eFax,
                Employee.Email <span class="org-keyword">AS</span> eEmail,
                Customer.CustomerId <span class="org-keyword">AS</span> cCustomerId,
                Customer.FirstName <span class="org-keyword">AS</span> cFirstName,
                Customer.LastName <span class="org-keyword">AS</span> cLastName,
                Customer.Company <span class="org-keyword">AS</span> cCompany,
                Customer.Address <span class="org-keyword">AS</span> cAddress,
                Customer.City <span class="org-keyword">AS</span> cCity,
                Customer.<span class="org-keyword">State</span> <span class="org-keyword">AS</span> cState,
                Customer.Country <span class="org-keyword">AS</span> cCountry,
                Customer.PostalCode <span class="org-keyword">AS</span> cPostalCode,
                Customer.Phone <span class="org-keyword">AS</span> cPhone,
                Customer.Fax <span class="org-keyword">AS</span> cFax,
                Customer.Email <span class="org-keyword">AS</span> cEmail
<span class="org-keyword">FROM</span> Customer <span class="org-keyword">LEFT</span> <span class="org-keyword">JOIN</span> Employee
<span class="org-keyword">ON</span> Employee.EmployeeId = Customer.SupportRepId;
</pre>
</div>
</div>
</li>
</ol>
</li>
<li>
<a id="orgc3a173d"></a>Anti-Join<br>
<div class="outline-text-5" id="text-1-3-6-4">
<p>
Relational does not currently provide an anti-join operation.  Antijoin
returns those entries in the first table that do not have a corresponding
joining value in the second table.  I added the antijoin operation to
Relational using the definition given on Wikipedia;
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">return</span> <span class="org-keyword">self</span>.difference(<span class="org-keyword">self</span>.semijoin_left(other))
</pre>
</div>
<p>
Like other methods in the Relational class, antijoin takes a single table
class argument, anti-joins it onto the acting object, and returns a new
table object.  In the following example, employee is antijoined with
customer, joining on EmployeeId.  Equivalently named columns that are not
joined on have to be renamed in one of the tables.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">cn</span> = customer.rename({<span class="org-string">"SupportRepId"</span>: <span class="org-string">"EmployeeId"</span>, <span class="org-string">"LastName"</span>: <span class="org-string">"cLastName"</span>,
                      <span class="org-string">"FirstName"</span>: <span class="org-string">"cFirstName"</span>, <span class="org-string">"Company"</span>: <span class="org-string">"cCompany"</span>,
                      <span class="org-string">"Address"</span>: <span class="org-string">"cAddress"</span>, <span class="org-string">"City"</span>: <span class="org-string">"cCity"</span>, <span class="org-string">"State"</span>: <span class="org-string">"cState"</span>,
                      <span class="org-string">"Country"</span>: <span class="org-string">"cCountry"</span>, <span class="org-string">"PostalCode"</span>: <span class="org-string">"cPostalCode"</span>,
                      <span class="org-string">"Phone"</span>: <span class="org-string">"cPhone"</span>, <span class="org-string">"Fax"</span>: <span class="org-string">"cFax"</span>, <span class="org-string">"Email"</span>: <span class="org-string">"cEmail"</span>})
<span class="org-variable-name">jn</span> = employee.antijoin(cn)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(jn))
</pre>
</div>
</div>

<ol class="org-ol">
<li>
<a id="orgbebebfb"></a>With Correlated Subqueries<br>
<div class="outline-text-6" id="text-1-3-6-4-1">
<p>
In SQL, the typical way of performing an antijoin is by using correlated
subqueries.
</p>
<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> EmployeeId,
       Employee.LastName,
       Employee.FirstName,
       Employee.Title,
       Employee.ReportsTo,
       Employee.BirthDate,
       Employee.HireDate,
       Employee.Address,
       Employee.City,
       Employee.<span class="org-keyword">State</span>,
       Employee.Country,
       Employee.PostalCode,
       Employee.Phone,
       Employee.Fax,
       Employee.Email
<span class="org-keyword">FROM</span> Employee <span class="org-keyword">WHERE</span> <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
(<span class="org-keyword">SELECT</span> * <span class="org-keyword">FROM</span> Customer
<span class="org-keyword">WHERE</span> Employee.EmployeeId = Customer.SupportRepId);
</pre>
</div>

<p>
This query has the following plan in SQLite.
</p>

<div class="org-src-container">
<pre class="src src-sqlite">EXPLAIN QUERY PLAN
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> EmployeeId,
       Employee.LastName,
       Employee.FirstName,
       Employee.Title,
       Employee.ReportsTo,
       Employee.BirthDate,
       Employee.HireDate,
       Employee.Address,
       Employee.City,
       Employee.<span class="org-keyword">State</span>,
       Employee.Country,
       Employee.PostalCode,
       Employee.Phone,
       Employee.Fax,
       Employee.Email
<span class="org-keyword">FROM</span> Employee <span class="org-keyword">WHERE</span> <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
(<span class="org-keyword">SELECT</span> * <span class="org-keyword">FROM</span> Customer
<span class="org-keyword">WHERE</span> Employee.EmployeeId = Customer.SupportRepId);
</pre>
</div>
</div>
</li>

<li>
<a id="orgf176625"></a>With the Relation Algebra Definition<br>
<div class="outline-text-6" id="text-1-3-6-4-2">
<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> * <span class="org-keyword">FROM</span> Employee
<span class="org-keyword">EXCEPT</span>
<span class="org-keyword">SELECT</span> EmployeeId,
       Employee.LastName,
       Employee.FirstName,
       Employee.Title,
       Employee.ReportsTo,
       Employee.BirthDate,
       Employee.HireDate,
       Employee.Address,
       Employee.City,
       Employee.<span class="org-keyword">State</span>,
       Employee.Country,
       Employee.PostalCode,
       Employee.Phone,
       Employee.Fax,
       Employee.Email
<span class="org-keyword">FROM</span> Employee <span class="org-keyword">JOIN</span> Customer
<span class="org-keyword">ON</span> Employee.EmployeeId = Customer.SupportRepId;
</pre>
</div>

<p>
It has the following plan in SQLite.
</p>

<div class="org-src-container">
<pre class="src src-sqlite">EXPLAIN QUERY PLAN
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> * <span class="org-keyword">FROM</span> Employee
<span class="org-keyword">EXCEPT</span>
<span class="org-keyword">SELECT</span> EmployeeId,
       Employee.LastName,
       Employee.FirstName,
       Employee.Title,
       Employee.ReportsTo,
       Employee.BirthDate,
       Employee.HireDate,
       Employee.Address,
       Employee.City,
       Employee.<span class="org-keyword">State</span>,
       Employee.Country,
       Employee.PostalCode,
       Employee.Phone,
       Employee.Fax,
       Employee.Email
<span class="org-keyword">FROM</span> Employee <span class="org-keyword">JOIN</span> Customer
<span class="org-keyword">ON</span> Employee.EmployeeId = Customer.SupportRepId;
</pre>
</div>

<p>
This query selects all columns in the Employee table, so select * rather
than explicitly specifying columns should not affect the query.&amp;nbsp; This
anti-join might not produce the same results in all cases as the other due
to null equality handling differences.&amp;nbsp; EXCEPT treats them as
equivalent.&amp;nbsp; I prefer this one over the former.&amp;nbsp; With toolkits
such as <a href="http://www.sqlalchemy.org/">SQLAlchemy</a>, it is difficult to code correlated subqueries.&amp;nbsp;
Furthermore, this version may be faster, reasons for which I will detail
later.&amp;nbsp; It may be possible to modify this query to treat nulls as not
equal.&amp;nbsp; This issue would only arise if nulls exist in the joining
columns.&amp;nbsp; Null columns could be added to the anti-join result by
intersecting the projection of the two tables' joining columns, selecting
those rows that contain nulls, select the corresponding rows in the first
table, and unioning them to the antijoin result.
</p>
</div>
</li>
</ol>
</li>

<li>
<a id="org5e64ec4"></a>Division<br>
<div class="outline-text-5" id="text-1-3-6-5">
<p>
Division is an operation that is somewhat difficult to grasp, and the
traditional correlated SQL query even more difficult.&amp;nbsp; When dividing
one table by another, columns unique to the first table are returned.&amp;nbsp;
The column names in the second table must be a subset of the first.&amp;nbsp;
Rows in the first table can be thought of as being grouped by values in the
return columns.&amp;nbsp; A group is returned only if, for every row in the
second table, there exists a row in the group with values that exist in the
second table.
</p>

<p>
In Python, like the other Relational methods, division takes a single table
argument and returns a relation table object.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">cp</span> = customer.projection(<span class="org-string">"CustomerId"</span>, <span class="org-string">"State"</span>)
<span class="org-variable-name">ep</span> = employee.projection(<span class="org-string">"State"</span>)
<span class="org-variable-name">div</span> = cp.division(ep)
<span class="org-variable-name">cust</span> = customer.semijoin_left(div)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(cust))
</pre>
</div>
</div>

<ol class="org-ol">
<li>
<a id="orgeb22a51"></a>Example<br>
<div class="outline-text-6" id="text-1-3-6-5-1">
<p>
In this example, columns A and B are common to the input tables and C and
D are unique to the first.&amp;nbsp; Only the group of rows with 0,0 in C,D
have all of the A,B columns values existing in the second table.
</p>

<table id="org9731712" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="org-right">

<col class="org-right">

<col class="org-right">

<col class="org-right">
</colgroup>
<tbody>
<tr>
<td class="org-right">A</td>
<td class="org-right">B</td>
<td class="org-right">C</td>
<td class="org-right">D</td>
</tr>

<tr>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>

<table id="orgb44d9b3" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="org-right">

<col class="org-right">
</colgroup>
<tbody>
<tr>
<td class="org-right">A</td>
<td class="org-right">B</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-variable-name">rel1</span> = RelationOrg(in_table)
<span class="org-variable-name">rel2</span> = RelationOrg(other_table)
<span class="org-variable-name">prod</span> = rel1.division(rel2)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(prod))
</pre>
</div>
<div class="org-src-container">
<pre class="src src-org" id="org5540d76">    <span class="org-org-table">| D | C |</span>
    <span class="org-org-table">|---+---|</span>
    <span class="org-org-table">| 0 | 0 |</span>
</pre>
</div>
</div>
</li>

<li>
<a id="orgb5ab875"></a>Relational Algebra Definition<br>
<div class="outline-text-6" id="text-1-3-6-5-2">
<p>
The Wikipedia page on relational algebra defines the division of table \(R\) by table \(S\) as:
\(R\div S = \pi_pR - V\); where \(p\) is the set of columns unique to \(R\).
</p>

<p>
Substituting \(V\):
\(R\div S = \pi_pR - \pi_pU\)
Substituting U:
\(R\div S = \pi_pR - \pi_p(T - R)\)
Substituting T:
\(R\div S = \pi_pR - \pi_p(\pi_pR\times S - R)\)
</p>

<p>
In Relational Python:
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">cp</span> = customer.projection(<span class="org-string">"CustomerId"</span>, <span class="org-string">"State"</span>)
<span class="org-variable-name">ep</span> = employee.projection(<span class="org-string">"State"</span>)
<span class="org-variable-name">pi_c</span> = cp.projection(<span class="org-string">"CustomerId"</span>)
<span class="org-variable-name">cross</span> = pi_c.product(ep)
<span class="org-variable-name">diff</span> = cross.difference(cp)
<span class="org-variable-name">pi_diff</span> = diff.projection(<span class="org-string">"CustomerId"</span>)
<span class="org-variable-name">div</span> = pi_c.difference(pi_diff)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(div))
</pre>
</div>
</div>
</li>

<li>
<a id="orgfe6cb9d"></a>With Correlated Subqueries<br>
<div class="outline-text-6" id="text-1-3-6-5-3">
<p>
The way division is traditionally performed in SQL textbooks is by using
correlated subqueries.
</p>

<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> Quotient.CustomerId
<span class="org-keyword">FROM</span> Customer <span class="org-keyword">AS</span> Quotient
<span class="org-keyword">WHERE</span> <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
  (<span class="org-keyword">SELECT</span> Dividend.<span class="org-keyword">state</span>
   <span class="org-keyword">FROM</span> Employee <span class="org-keyword">AS</span> Dividend
   <span class="org-keyword">WHERE</span> <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
     (<span class="org-keyword">SELECT</span> Divisor.<span class="org-keyword">state</span>
      <span class="org-keyword">FROM</span> Customer <span class="org-keyword">AS</span> Divisor
      <span class="org-keyword">WHERE</span> Dividend.<span class="org-keyword">state</span> = Divisor.<span class="org-keyword">state</span>
      <span class="org-keyword">AND</span> Quotient.CustomerId = Divisor.CustomerId));
</pre>
</div>

<p>
This query has the following plan in SQLite.
</p>

<div class="org-src-container">
<pre class="src src-sqlite">EXPLAIN QUERY PLAN
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> Quotient.CustomerId
<span class="org-keyword">FROM</span> Customer <span class="org-keyword">AS</span> Quotient
<span class="org-keyword">WHERE</span> <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
  (<span class="org-keyword">SELECT</span> Dividend.<span class="org-keyword">state</span>
   <span class="org-keyword">FROM</span> Employee <span class="org-keyword">AS</span> Dividend
   <span class="org-keyword">WHERE</span> <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
     (<span class="org-keyword">SELECT</span> Divisor.<span class="org-keyword">state</span>
      <span class="org-keyword">FROM</span> Customer <span class="org-keyword">AS</span> Divisor
      <span class="org-keyword">WHERE</span> Dividend.<span class="org-keyword">state</span> = Divisor.<span class="org-keyword">state</span>
      <span class="org-keyword">AND</span> Quotient.CustomerId = Divisor.CustomerId));
</pre>
</div>
</div>
</li>

<li>
<a id="orge3344ac"></a>With the Relation Algebra Definition<br>
<div class="outline-text-6" id="text-1-3-6-5-4">
<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> CustomerId
<span class="org-keyword">FROM</span> Customer
<span class="org-keyword">EXCEPT</span>
<span class="org-keyword">SELECT</span> CustomerID
<span class="org-keyword">FROM</span>
  (<span class="org-keyword">SELECT</span> Customer.CustomerId, Employee.<span class="org-keyword">state</span>
   <span class="org-keyword">FROM</span> Customer, Employee
   <span class="org-keyword">EXCEPT</span>
   <span class="org-keyword">SELECT</span> CustomerId, <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Customer);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite">EXPLAIN QUERY PLAN
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> CustomerId
<span class="org-keyword">FROM</span> Customer
<span class="org-keyword">EXCEPT</span>
<span class="org-keyword">SELECT</span> CustomerID
<span class="org-keyword">FROM</span>
  (<span class="org-keyword">SELECT</span> Customer.CustomerId, Employee.<span class="org-keyword">state</span>
   <span class="org-keyword">FROM</span> Customer, Employee
   <span class="org-keyword">EXCEPT</span>
   <span class="org-keyword">SELECT</span> CustomerId, <span class="org-keyword">state</span> <span class="org-keyword">FROM</span> Customer);
</pre>
</div>

<p>
This query plan is two steps longer than the correlated subquery version;
however, I have found this version faster (more on that in the next
section), and this version is more easily coded in toolkits like
SQLAlchemy.&amp;nbsp; With this version, null values are treated as equal.&amp;nbsp;
If there are nulls in the second table, and if nulls are not equal, then
division should always return an empty table.&amp;nbsp; If there are null values
in the columns unique to the first table, and nulls are not equal, then
those rows can only be returned if the second table is one row long.
</p>
</div>
</li>
<li>
<a id="orgf94773a"></a>SQL using aggregation<br>
<div class="outline-text-6" id="text-1-3-6-5-5">
<p>
Adapted from p. 715 of SQL for Smarties.
</p>
<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> CustomerId
<span class="org-keyword">FROM</span> Customer, Employee
<span class="org-keyword">WHERE</span> Customer.<span class="org-keyword">state</span> = Employee.<span class="org-keyword">state</span>
<span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span> Customer.CustomerId
<span class="org-keyword">HAVING</span> <span class="org-builtin">COUNT</span>(Customer.<span class="org-keyword">state</span>) = (<span class="org-keyword">SELECT</span> <span class="org-builtin">COUNT</span>(<span class="org-keyword">state</span>) <span class="org-keyword">FROM</span> Employee);
</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</div>
</div>

<div id="outline-container-org5dc890c" class="outline-3">
<h3 id="org5dc890c">
<span class="section-number-3">1.4</span> Complex Queries</h3>
<div class="outline-text-3" id="text-1-4">
<p>
As I mentioned in the introduction, I find Relational useful for prototyping
complex queries.  In this example, I will join a bunch of tables in the
Chinook database and then increase the complexity in the next section by
adding division.  You will likely find it easier to follow what is going on
in the Relational version rather than the SQL version.  The SQL versions
were coded after the Relational version was written.
</p>
</div>

<div id="outline-container-org3596ee1" class="outline-4">
<h4 id="org3596ee1">
<span class="section-number-4">1.4.1</span> Multiple Joins</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
The following code joins the tables: artist, album, track, genre,
playlist_track, and playlist; they are all joined together in order to find
playlists that contain rock and list the artists on those playlists.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">artist_rn</span> = artist.rename({<span class="org-string">"Name"</span>: <span class="org-string">"artist_name"</span>})
<span class="org-variable-name">track_rn</span> = track.projection(<span class="org-string">"TrackId"</span>, <span class="org-string">"AlbumId"</span>, <span class="org-string">"GenreId"</span>)
<span class="org-variable-name">genre_rn</span> = genre.selection(<span class="org-string">"Name == 'Rock'"</span>).projection(<span class="org-string">"GenreId"</span>)
<span class="org-variable-name">playlist_rn</span> = playlist.rename({<span class="org-string">"Name"</span>: <span class="org-string">"playlist_name"</span>})
<span class="org-variable-name">album_artist</span> = artist_rn.join(album).projection(<span class="org-string">"artist_name"</span>, <span class="org-string">"AlbumId"</span>)
<span class="org-variable-name">a_a_track</span> = album_artist.join(track_rn).projection(<span class="org-string">"TrackId"</span>, <span class="org-string">"GenreId"</span>, <span class="org-string">"artist_name"</span>)
<span class="org-variable-name">a_a_t_g</span> = a_a_track.join(genre_rn).projection(<span class="org-string">"TrackId"</span>, <span class="org-string">"artist_name"</span>)
<span class="org-variable-name">a_a_t_g_pt</span> = a_a_t_g.join(playlist_track)
<span class="org-variable-name">result</span> = a_a_t_g_pt.join(playlist_rn).projection(<span class="org-string">"artist_name"</span>, <span class="org-string">"playlist_name"</span>)
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(RelationOrg(result))
</pre>
</div>

<p>
In SQL, this translates to:
</p>
<div class="org-src-container">
<pre class="src src-sqlite"><span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> a_a_t_g_pt.<span class="org-keyword">Name</span>, Playlist.<span class="org-keyword">Name</span>
<span class="org-keyword">FROM</span> Playlist <span class="org-keyword">JOIN</span>
  (<span class="org-keyword">SELECT</span> * <span class="org-keyword">FROM</span> PlaylistTrack
  <span class="org-keyword">JOIN</span>
    (<span class="org-keyword">SELECT</span> TrackId, a_a_track.<span class="org-keyword">Name</span>
    <span class="org-keyword">FROM</span> Genre <span class="org-keyword">JOIN</span>
      (<span class="org-keyword">SELECT</span> TrackId, GenreId, album_artist.<span class="org-keyword">Name</span>
      <span class="org-keyword">FROM</span> Track <span class="org-keyword">JOIN</span>
        (<span class="org-keyword">SELECT</span> Artist.<span class="org-keyword">Name</span>, AlbumId
        <span class="org-keyword">FROM</span> Artist <span class="org-keyword">JOIN</span> Album
        <span class="org-keyword">USING</span> (ArtistId)) <span class="org-keyword">AS</span> album_artist
      <span class="org-keyword">USING</span> (AlbumId)) <span class="org-keyword">AS</span> a_a_track
    <span class="org-keyword">USING</span> (GenreId)
    <span class="org-keyword">WHERE</span> Genre.<span class="org-keyword">Name</span> = <span class="org-string">'Rock'</span>)
  <span class="org-keyword">USING</span> (TrackId)) <span class="org-keyword">AS</span> a_a_t_g_pt
<span class="org-keyword">USING</span> (PlaylistId);
</pre>
</div>
<p>
You will notice that the Relational version is sequential, while the SQL
version is nested, five levels deep.  The SQL version could be made more
sequential by using temporary tables or common table expressions (CTEs),
depending on the SQL engine.  However, SQL still requires you to do, in
every SQL query, a projection plus zero or more other operations, so it is
never going to be as succinct.  Furthermore, if you are using tools such as
SQLAlchemy, you are either forced to write plain SQL, hope that the tool
supports whatever mechanism the database uses to create temporary tables, or
use the nested version. (SQLAlchemy does not support MySQL temporary tables,
it does support CTEs; however, MySQL does not have CTEs).
</p>
</div>
</div>

<div id="outline-container-org4e5f40a" class="outline-4">
<h4 id="org4e5f40a">
<span class="section-number-4">1.4.2</span> Adding Division</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
To make the previous query more interesting, the selected playlists must now
contain metal and heavy metal in addition to rock, and we also want to
display the genres on the playlist.&amp;nbsp; All of the same joins are made,
but there are two tables derived from the genre table; one to join on and
the other to divide with.  After doing all of the joins, the resulting table
is divided by a projected genre table. The resulting table is joined with
the table that was divided, getting back those columns that the division
removed.  The genre table is also joined on to get the genre names.  We then
project the columns we want.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">artist_rn</span> = artist.rename({<span class="org-string">"Name"</span>: <span class="org-string">"artist_name"</span>})
<span class="org-variable-name">track_rn</span> = track.projection(<span class="org-string">"TrackId"</span>, <span class="org-string">"AlbumId"</span>, <span class="org-string">"GenreId"</span>)
<span class="org-variable-name">genre_p</span> = genre.projection(<span class="org-string">"GenreId"</span>)
<span class="org-variable-name">genre_div</span> = genre.selection(<span class="org-string">"Name == 'Metal' or Name == 'Heavy Metal' or Name == 'Rock'"</span>).projection(<span class="org-string">"GenreId"</span>)
<span class="org-variable-name">playlist_rn</span> = playlist.rename({<span class="org-string">"Name"</span>: <span class="org-string">"playlist_name"</span>})
<span class="org-variable-name">album_artist</span> = artist_rn.join(album).projection(<span class="org-string">"artist_name"</span>, <span class="org-string">"AlbumId"</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">join on AristId</span>
<span class="org-variable-name">a_a_track</span> = album_artist.join(track_rn).projection(<span class="org-string">"TrackId"</span>, <span class="org-string">"GenreId"</span>, <span class="org-string">"artist_name"</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">join on AlbumId</span>
<span class="org-variable-name">a_a_t_g</span> = a_a_track.join(genre_p).projection(<span class="org-string">"TrackId"</span>, <span class="org-string">"artist_name"</span>, <span class="org-string">"GenreId"</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">join on GenreId</span>
<span class="org-variable-name">a_a_t_g_pt</span> = a_a_t_g.join(playlist_track) <span class="org-comment-delimiter"># </span><span class="org-comment">join on TrackId, columns: "TrackId", "artist_name", "GenreId", "PlaylistId"</span>
<span class="org-variable-name">a_a_t_g_pt_p</span> = a_a_t_g_pt.join(playlist_rn) <span class="org-comment-delimiter"># </span><span class="org-comment">join on PlaylistId, columns: "TrackId", "artist_name", "GenreId", "PlaylistId", "playlist_name"</span>
<span class="org-variable-name">quot</span> = a_a_t_g_pt_p.projection(<span class="org-string">"GenreId"</span>, <span class="org-string">"PlaylistId"</span>).division(genre_div) <span class="org-comment-delimiter"># </span><span class="org-comment">resulting columns: "PlaylistId"</span>
<span class="org-variable-name">a_a_t_g_pt_p_q</span> = a_a_t_g_pt_p.join(quot) <span class="org-comment-delimiter"># </span><span class="org-comment">join on PlaylistId, columns: "TrackId", "artist_name", "GenreId", "PlaylistId", "playlist_name"</span>
<span class="org-variable-name">result</span> = a_a_t_g_pt_p_q.join(genre).projection(<span class="org-string">"artist_name"</span>, <span class="org-string">"playlist_name"</span>, <span class="org-string">"Name"</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">join on GenreId, "Name' is genre Name</span>
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(<span class="org-builtin">len</span>(RelationOrg(result)))
</pre>
</div>

<p>
Expanding the division results in:
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> sys
sys.path.append(<span class="org-string">"/home/devin/projects/relational/"</span>)
<span class="org-keyword">from</span> relational.relation_org <span class="org-keyword">import</span> RelationOrg
<span class="org-keyword">from</span> relational.relation <span class="org-keyword">import</span> Relation
<span class="org-variable-name">root_fp</span> = <span class="org-string">"/home/devin/notes/sql-relational-algebra/chinook/csv/"</span>
<span class="org-variable-name">album</span> = Relation(root_fp + <span class="org-string">"album.csv"</span>)
<span class="org-variable-name">artist</span> = Relation(root_fp + <span class="org-string">"artist.csv"</span>)
<span class="org-variable-name">customer</span> = Relation(root_fp + <span class="org-string">"customer.csv"</span>)
<span class="org-variable-name">employee</span> = Relation(root_fp + <span class="org-string">"employee.csv"</span>)
<span class="org-variable-name">genre</span> = Relation(root_fp + <span class="org-string">"genre.csv"</span>)
<span class="org-variable-name">invoice_line</span> = Relation(root_fp + <span class="org-string">"invoice-line.csv"</span>)
<span class="org-variable-name">invoice</span> = Relation(root_fp + <span class="org-string">"invoice.csv"</span>)
<span class="org-variable-name">media_type</span> = Relation(root_fp + <span class="org-string">"media-type.csv"</span>)
<span class="org-variable-name">playlist_track</span> = Relation(root_fp + <span class="org-string">"playlist-track.csv"</span>)
<span class="org-variable-name">playlist</span> = Relation(root_fp + <span class="org-string">"playlist.csv"</span>)
<span class="org-variable-name">track</span> = Relation(root_fp + <span class="org-string">"track.csv"</span>)
<span class="org-variable-name">artist_rn</span> = artist.rename({<span class="org-string">"Name"</span>: <span class="org-string">"artist_name"</span>})
<span class="org-variable-name">track_rn</span> = track.projection(<span class="org-string">"TrackId"</span>, <span class="org-string">"AlbumId"</span>, <span class="org-string">"GenreId"</span>)
<span class="org-variable-name">genre_p</span> = genre.projection(<span class="org-string">"GenreId"</span>)
<span class="org-variable-name">genre_div</span> = genre.selection(<span class="org-string">"Name == 'Metal' or Name == 'Heavy Metal' or Name == 'Rock'"</span>).projection(<span class="org-string">"GenreId"</span>)
<span class="org-variable-name">playlist_rn</span> = playlist.rename({<span class="org-string">"Name"</span>: <span class="org-string">"playlist_name"</span>})
<span class="org-variable-name">album_artist</span> = artist_rn.join(album).projection(<span class="org-string">"artist_name"</span>, <span class="org-string">"AlbumId"</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">join on AristId</span>
<span class="org-variable-name">a_a_track</span> = album_artist.join(track_rn).projection(<span class="org-string">"TrackId"</span>, <span class="org-string">"GenreId"</span>, <span class="org-string">"artist_name"</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">join on AlbumId</span>
<span class="org-variable-name">a_a_t_g</span> = a_a_track.join(genre_p).projection(<span class="org-string">"TrackId"</span>, <span class="org-string">"artist_name"</span>, <span class="org-string">"GenreId"</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">join on GenreId</span>
<span class="org-variable-name">a_a_t_g_pt</span> = a_a_t_g.join(playlist_track) <span class="org-comment-delimiter"># </span><span class="org-comment">join on TrackId, columns: "TrackId", "artist_name", "GenreId", "PlaylistId"</span>
<span class="org-variable-name">a_a_t_g_pt_p</span> = a_a_t_g_pt.join(playlist_rn) <span class="org-comment-delimiter"># </span><span class="org-comment">join on PlaylistId, columns: "TrackId", "artist_name", "GenreId", "PlaylistId", "playlist_name"</span>
<span class="org-variable-name">dividend</span> = a_a_t_g_pt_p.projection(<span class="org-string">"GenreId"</span>, <span class="org-string">"PlaylistId"</span>)
<span class="org-variable-name">dividend_p</span> = dividend.projection(<span class="org-string">"PlaylistId"</span>)
<span class="org-variable-name">V</span> = dividend_p.product(genre_div).difference(dividend).projection(<span class="org-string">"PlaylistId"</span>)
<span class="org-variable-name">quot</span> = dividend_p.difference(V)
<span class="org-variable-name">a_a_t_g_pt_p_q</span> = a_a_t_g_pt_p.join(quot) <span class="org-comment-delimiter"># </span><span class="org-comment">join on PlaylistId, columns: "TrackId", "artist_name", "GenreId", "PlaylistId", "playlist_name"</span>
<span class="org-variable-name">result</span> = a_a_t_g_pt_p_q.join(genre).projection(<span class="org-string">"artist_name"</span>, <span class="org-string">"playlist_name"</span>, <span class="org-string">"Name"</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">join on GenreId, "Name' is genre Name</span>
<span class="org-keyword">return</span> <span class="org-builtin">str</span>(<span class="org-builtin">len</span>(RelationOrg(result)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org588d383" class="outline-4">
<h4 id="org588d383">
<span class="section-number-4">1.4.3</span> With Correlated Subqueries</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
SQL's CTE system is used to create three temporary tables; the table
containing the result of joining multiple tables, a table to divide by, and
the division.  A temporary table is required for the a_a_t_g_pt_p table
because it is referenced twice.  The other tables could be in-lined.
Executing this query took almost 23 seconds!
</p>

<div class="org-src-container">
<pre class="src src-sqlite">.timer <span class="org-keyword">ON</span>
<span class="org-keyword">WITH</span> a_a_t_g_pt_p <span class="org-keyword">AS</span>
(<span class="org-keyword">SELECT</span> artist_name, a_a_t_g_pt.GenreId, Playlist.<span class="org-keyword">Name</span> <span class="org-keyword">AS</span> playlist_name, Playlist.PlaylistId, a_a_t_g_pt.TrackId
<span class="org-keyword">FROM</span> Playlist <span class="org-keyword">JOIN</span>
  (<span class="org-keyword">SELECT</span> a_a_t_g.GenreId, PlaylistId, PlaylistTrack.TrackId, artist_name
  <span class="org-keyword">FROM</span> PlaylistTrack <span class="org-keyword">JOIN</span>
    (<span class="org-keyword">SELECT</span> a_a_track.TrackId, artist_name, Genre.GenreId
    <span class="org-keyword">FROM</span> Genre <span class="org-keyword">JOIN</span>
      (<span class="org-keyword">SELECT</span> Track.TrackId, Track.GenreId, artist_name
      <span class="org-keyword">FROM</span> Track <span class="org-keyword">JOIN</span>
        (<span class="org-keyword">SELECT</span> Artist.<span class="org-keyword">Name</span> <span class="org-keyword">AS</span> artist_name, AlbumId
        <span class="org-keyword">FROM</span> Artist <span class="org-keyword">JOIN</span> Album
        <span class="org-keyword">USING</span> (ArtistId)) <span class="org-keyword">AS</span> album_artist
      <span class="org-keyword">USING</span> (AlbumId)) <span class="org-keyword">AS</span> a_a_track
    <span class="org-keyword">USING</span> (GenreId)) <span class="org-keyword">AS</span> a_a_t_g
  <span class="org-keyword">USING</span> (TrackId)) <span class="org-keyword">AS</span> a_a_t_g_pt
<span class="org-keyword">USING</span> (PlaylistId)),

divisor <span class="org-keyword">AS</span>
(<span class="org-keyword">SELECT</span> GenreId <span class="org-keyword">FROM</span> Genre
<span class="org-keyword">WHERE</span> <span class="org-keyword">Name</span> = <span class="org-string">'Rock'</span> <span class="org-keyword">OR</span> <span class="org-keyword">Name</span> = <span class="org-string">'Metal'</span> <span class="org-keyword">OR</span> <span class="org-keyword">Name</span> = <span class="org-string">'Heavy Metal'</span>)

<span class="org-keyword">SELECT</span> <span class="org-builtin">COUNT</span>(*) <span class="org-keyword">FROM</span> (
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> artist_name, playlist_name, Genre.<span class="org-keyword">Name</span>
<span class="org-keyword">FROM</span> Genre <span class="org-keyword">JOIN</span>
  (<span class="org-keyword">SELECT</span> quot.PlaylistId, TrackId, artist_name, GenreId, playlist_name
  <span class="org-keyword">FROM</span> a_a_t_g_pt_p <span class="org-keyword">JOIN</span>
  <span class="org-comment">-- quot</span>
    (<span class="org-keyword">SELECT</span> PlaylistId
    <span class="org-keyword">FROM</span> a_a_t_g_pt_p <span class="org-keyword">AS</span> Quotient
    <span class="org-keyword">WHERE</span> <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
      (<span class="org-keyword">SELECT</span> divisor.GenreId
      <span class="org-keyword">FROM</span> divisor
      <span class="org-keyword">WHERE</span> <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
        (<span class="org-keyword">SELECT</span> dividend.GenreId
        <span class="org-keyword">FROM</span> a_a_t_g_pt_p <span class="org-keyword">AS</span> dividend
        <span class="org-keyword">WHERE</span> Quotient.PlaylistId = dividend.PlaylistId
        <span class="org-keyword">AND</span> divisor.GenreId = dividend.GenreId))) <span class="org-keyword">AS</span> quot
  <span class="org-comment">-- end quot</span>
  <span class="org-keyword">USING</span> (PlaylistId)) <span class="org-keyword">AS</span> a_a_t_g_pt_p_q
<span class="org-keyword">USING</span> (GenreId));
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sqlite">.timer <span class="org-keyword">ON</span>
<span class="org-keyword">WITH</span> a_a_t_g_pt_p <span class="org-keyword">AS</span>
(<span class="org-keyword">SELECT</span> artist_name, a_a_t_g_pt.GenreId, Playlist.<span class="org-keyword">Name</span> <span class="org-keyword">AS</span> playlist_name, Playlist.PlaylistId, a_a_t_g_pt.TrackId
<span class="org-keyword">FROM</span> Playlist <span class="org-keyword">JOIN</span>
  (<span class="org-keyword">SELECT</span> a_a_t_g.GenreId, PlaylistId, PlaylistTrack.TrackId, artist_name
  <span class="org-keyword">FROM</span> PlaylistTrack <span class="org-keyword">JOIN</span>
    (<span class="org-keyword">SELECT</span> a_a_track.TrackId, artist_name, Genre.GenreId
    <span class="org-keyword">FROM</span> Genre <span class="org-keyword">JOIN</span>
      (<span class="org-keyword">SELECT</span> Track.TrackId, Track.GenreId, artist_name
      <span class="org-keyword">FROM</span> Track <span class="org-keyword">JOIN</span>
        (<span class="org-keyword">SELECT</span> Artist.<span class="org-keyword">Name</span> <span class="org-keyword">AS</span> artist_name, AlbumId
        <span class="org-keyword">FROM</span> Artist <span class="org-keyword">JOIN</span> Album
        <span class="org-keyword">USING</span> (ArtistId)) <span class="org-keyword">AS</span> album_artist
      <span class="org-keyword">USING</span> (AlbumId)) <span class="org-keyword">AS</span> a_a_track
    <span class="org-keyword">USING</span> (GenreId)) <span class="org-keyword">AS</span> a_a_t_g
  <span class="org-keyword">USING</span> (TrackId)) <span class="org-keyword">AS</span> a_a_t_g_pt
<span class="org-keyword">USING</span> (PlaylistId)),

divisor <span class="org-keyword">AS</span>
(<span class="org-keyword">SELECT</span> GenreId <span class="org-keyword">FROM</span> Genre
<span class="org-keyword">WHERE</span> <span class="org-keyword">Name</span> = <span class="org-string">'Rock'</span> <span class="org-keyword">OR</span> <span class="org-keyword">Name</span> = <span class="org-string">'Metal'</span> <span class="org-keyword">OR</span> <span class="org-keyword">Name</span> = <span class="org-string">'Heavy Metal'</span>),

quot <span class="org-keyword">AS</span>
(<span class="org-keyword">SELECT</span> PlaylistId
<span class="org-keyword">FROM</span> a_a_t_g_pt_p <span class="org-keyword">AS</span> Quotient
<span class="org-keyword">WHERE</span> <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
  (<span class="org-keyword">SELECT</span> divisor.GenreId
  <span class="org-keyword">FROM</span> divisor
  <span class="org-keyword">WHERE</span> <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
    (<span class="org-keyword">SELECT</span> dividend.GenreId
    <span class="org-keyword">FROM</span> a_a_t_g_pt_p <span class="org-keyword">AS</span> dividend
    <span class="org-keyword">WHERE</span> Quotient.PlaylistId = dividend.PlaylistId
        <span class="org-keyword">AND</span> divisor.GenreId = dividend.GenreId)))

<span class="org-keyword">SELECT</span> <span class="org-builtin">COUNT</span>(*) <span class="org-keyword">FROM</span> (
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> artist_name, playlist_name, Genre.<span class="org-keyword">Name</span>
<span class="org-keyword">FROM</span> Genre <span class="org-keyword">JOIN</span>
  (<span class="org-keyword">SELECT</span> quot.PlaylistId, TrackId, artist_name, GenreId, playlist_name
  <span class="org-keyword">FROM</span> a_a_t_g_pt_p <span class="org-keyword">JOIN</span> quot
  <span class="org-keyword">USING</span> (PlaylistId)) <span class="org-keyword">AS</span> a_a_t_g_pt_p_q
<span class="org-keyword">USING</span> (GenreId));
</pre>
</div>
</div>
</div>

<div id="outline-container-org2ee2315" class="outline-4">
<h4 id="org2ee2315">
<span class="section-number-4">1.4.4</span> With the Relation Algebra Definition</h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
The only difference between this version and the last is how division is
executed, and here I did not remove it from the main query.  In the previous
version, I originally had the division inside the main query and it was
still just as slow.  This query took just 0.06 seconds!
</p>
<div class="org-src-container">
<pre class="src src-sqlite">.timer <span class="org-keyword">ON</span>
<span class="org-keyword">WITH</span> a_a_t_g_pt_p <span class="org-keyword">AS</span>
(<span class="org-keyword">SELECT</span> artist_name, a_a_t_g_pt.GenreId, Playlist.<span class="org-keyword">Name</span> <span class="org-keyword">AS</span> playlist_name, Playlist.PlaylistId, a_a_t_g_pt.TrackId
<span class="org-keyword">FROM</span> Playlist <span class="org-keyword">JOIN</span>
  (<span class="org-keyword">SELECT</span> a_a_t_g.GenreId, PlaylistId, PlaylistTrack.TrackId, artist_name
  <span class="org-keyword">FROM</span> PlaylistTrack <span class="org-keyword">JOIN</span>
    (<span class="org-keyword">SELECT</span> a_a_track.TrackId, artist_name, Genre.GenreId
    <span class="org-keyword">FROM</span> Genre <span class="org-keyword">JOIN</span>
      (<span class="org-keyword">SELECT</span> Track.TrackId, Track.GenreId, artist_name
      <span class="org-keyword">FROM</span> Track <span class="org-keyword">JOIN</span>
        (<span class="org-keyword">SELECT</span> Artist.<span class="org-keyword">Name</span> <span class="org-keyword">AS</span> artist_name, AlbumId
        <span class="org-keyword">FROM</span> Artist <span class="org-keyword">JOIN</span> Album
        <span class="org-keyword">USING</span> (ArtistId)) <span class="org-keyword">AS</span> album_artist
      <span class="org-keyword">USING</span> (AlbumId)) <span class="org-keyword">AS</span> a_a_track
    <span class="org-keyword">USING</span> (GenreId)) <span class="org-keyword">AS</span> a_a_t_g
  <span class="org-keyword">USING</span> (TrackId)) <span class="org-keyword">AS</span> a_a_t_g_pt
<span class="org-keyword">USING</span> (PlaylistId)),

divisor <span class="org-keyword">AS</span>
(<span class="org-keyword">SELECT</span> GenreId <span class="org-keyword">FROM</span> Genre
<span class="org-keyword">WHERE</span> <span class="org-keyword">Name</span> = <span class="org-string">'Rock'</span> <span class="org-keyword">OR</span> <span class="org-keyword">Name</span> = <span class="org-string">'Metal'</span> <span class="org-keyword">OR</span> <span class="org-keyword">Name</span> = <span class="org-string">'Heavy Metal'</span>)

<span class="org-keyword">SELECT</span> <span class="org-builtin">COUNT</span>(*) <span class="org-keyword">FROM</span> (
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span> artist_name, playlist_name, Genre.<span class="org-keyword">Name</span>
<span class="org-keyword">FROM</span> Genre <span class="org-keyword">JOIN</span>
  (<span class="org-keyword">SELECT</span> quot.PlaylistId, TrackId, artist_name, GenreId, playlist_name
  <span class="org-keyword">FROM</span> a_a_t_g_pt_p <span class="org-keyword">JOIN</span>
  <span class="org-comment">-- quot</span>
    (<span class="org-keyword">SELECT</span> PlaylistId
    <span class="org-keyword">FROM</span> a_a_t_g_pt_p
    <span class="org-keyword">EXCEPT</span>
    <span class="org-keyword">SELECT</span> PlaylistId <span class="org-keyword">FROM</span>
      (<span class="org-keyword">SELECT</span> PlaylistId, divisor.GenreId
      <span class="org-keyword">FROM</span> a_a_t_g_pt_p, divisor
      <span class="org-keyword">EXCEPT</span>
      <span class="org-keyword">SELECT</span> PlaylistId, GenreId <span class="org-keyword">FROM</span> a_a_t_g_pt_p)) <span class="org-keyword">AS</span> quot
  <span class="org-comment">-- end quot</span>
  <span class="org-keyword">USING</span> (PlaylistId)) <span class="org-keyword">AS</span> a_a_t_g_pt_p_q
<span class="org-keyword">USING</span> (GenreId));
</pre>
</div>
</div>
</div>

<div id="outline-container-orgda58b58" class="outline-4">
<h4 id="orgda58b58">
<span class="section-number-4">1.4.5</span> Gotcha with Except</h4>
<div class="outline-text-4" id="text-1-4-5">
<p>
In writing the division operation for the previous query, I found what I
think to be a major flaw in either SQL or SQLite, that being if you do not
have the SELECT column names in the same order for tables being given to the
EXCEPT operator, the EXCEPT operator will not perform its function
correctly.  Instead it will think that the tables have nothing in common and
you will get the first table.  Tables are supposed to be sets of columns;
column order should not matter.  This bug was very difficult to diagnose.
It had me stepping through each statement, seeing what it returned, and
comparing it to what Relational returned.
</p>
</div>
</div>
</div>
<div id="outline-container-org5ea39c9" class="outline-3">
<h3 id="org5ea39c9">
<span class="section-number-3">1.5</span> Conclusion</h3>
<div class="outline-text-3" id="text-1-5">
<p>
In the non-trivial queries, Python Relational was invaluable in crafting such
queries.  The Relational query was entirely procedural and relatively easy to
follow.  I had to make notes about what was being joined on and what columns
were being returned.  Fortunately, it did not have SQL's nested structure.
SQL's nested structure makes it difficult to follow.  The results of inner
queries are syntactically given aliases after they are referenced, requiring
you to jump around the code a lot and keep track of what nesting level you
are at in order to make procedural sense of what is happening.&amp;nbsp;
Unfortunately, nothting like Relational currently exists for relational
databases.&amp;nbsp; There was a query language developed at IBM, <a href="https://en.wikipedia.org/wiki/IBM_Business_System_12">IBM BS12</a>,
that had such qualities.&amp;nbsp; I think Relational can be useful as a guide in
learning to query relational databases and possibly other database types by
practicing creating Relational queries along side database queries,
understanding complex SQL queries by having the Relational version to refer
back to, and prototyping new queries through sequential development.&amp;nbsp; In
database classes, learning relational algebra first and playing with it using
Relational, before diving into SQL (or at least before doing anti-join and
division in SQL), should help increase understanding.
</p>

<p>
For going from SQL to Relational, there is a paper by Jan Van den Bussche and
Stijn Vansummeren, <a href="http://cs.ulb.ac.be/public/_media/teaching/infoh417/sql2alg_eng.pdf">Translating SQL into the Relational Algebra</a>.  One
translation that I have yet to figure out is translating the correlated
subquery version of division.
</p>
</div>
</div>
</article>
</main><footer><div id="to-top-alt" class="mobile nav menu-btn"><a href="#">Back to Top</a></div></footer>
</body>
</html>
